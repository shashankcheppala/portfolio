<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Portfolio — Scroll Sequence Hero</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root{ --bg:#0a0a0c; --fg:#e9ecf1; --muted:#9aa3b2; --line:rgba(255,255,255,.08) }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui}
  a{color:inherit;text-decoration:none}

  /* Pinned sequence hero */
  .seq{height:260svh;position:relative;border-bottom:1px solid var(--line)}
  .pin{position:sticky;top:0;height:100svh;display:grid;place-items:center;background:#06070a}
  canvas{width:100vw;height:100svh;display:block}
  .loading{position:absolute;inset:auto 0 4vh;display:flex;justify-content:center;color:#98a2b3;font-size:14px;letter-spacing:.08em;text-transform:uppercase}

  /* Content sections */
  section{min-height:100svh;display:flex;align-items:center;border-top:1px solid var(--line)}
  .wrap{max-width:1100px;margin:0 auto;padding:0 24px}
  h1{margin:0 0 12px;font-size:clamp(28px,4vw,56px)}
  p.muted{color:var(--muted)}
  footer{padding:60px 0;text-align:center;color:#9aa3b2}
</style>
</head>
<body>

<!-- SEQUENCE HERO -->
<div class="seq">
  <div class="pin">
    <canvas id="scene" aria-label="Scroll animation"></canvas>
    <div id="loadmsg" class="loading">Loading…</div>
  </div>
</div>

<!-- CONTENT -->
<section id="work">
  <div class="wrap">
    <h1>Selected Work</h1>
    <p class="muted">Replace with your projects. The hero above scrubs a 241-frame sequence on scroll.</p>
  </div>
</section>

<section id="about">
  <div class="wrap">
    <h1>About</h1>
    <p class="muted">MS Data Analytics • NLP, CV, ML pipelines. Swap in your copy.</p>
  </div>
</section>

<footer>© <span id="y"></span> Your Name</footer>

<!-- GSAP -->
<script src="https://unpkg.com/gsap@3.12.5/dist/gsap.min.js"></script>
<script src="https://unpkg.com/gsap@3.12.5/dist/ScrollTrigger.min.js"></script>
<script>
document.getElementById('y').textContent = new Date().getFullYear();
gsap.registerPlugin(ScrollTrigger);

/* ===== Config ===== */
const FRAME_COUNT = 241;  // exact number of frames you have
const PATH = i => `media/sequence/frame_${String(i).padStart(4,'0')}.webp`;
const DPR = Math.min(window.devicePixelRatio || 1, 1.25); // clamp for perf
const LOOP_MODE = "loop"; // or "pingpong"

/* ===== Canvas ===== */
const canvas = document.getElementById('scene');
const ctx = canvas.getContext('2d', { alpha:false, desynchronized:true });
let naturalW = 1280, naturalH = 720; // updated after first decode

function resize(){
  const w = Math.floor(innerWidth * DPR);
  const h = Math.floor(innerHeight * DPR);
  canvas.width = w; canvas.height = h;
}
addEventListener('resize', resize);

/* ===== Fast cache using ImageBitmap ===== */
const loaded = new Array(FRAME_COUNT+1).fill(false);
const inflight = new Set();
const cache = new Map();              // LRU of ImageBitmaps
const MAX_CACHE = 24;

function keep(key, bmp){
  cache.set(key, bmp);
  if (cache.size > MAX_CACHE) cache.delete(cache.keys().next().value);
}

async function load(index){
  if (index<1 || index>FRAME_COUNT || loaded[index] || inflight.has(index)) return;
  inflight.add(index);
  try {
    const resp = await fetch(PATH(index), { cache: "force-cache" });
    if (!resp.ok) throw new Error("404 " + PATH(index));
    const blob = await resp.blob();
    const bmp = await createImageBitmap(blob, { colorSpaceConversion: "default", premultiplyAlpha: "premultiply" });
    if (index === 1) { naturalW = bmp.width; naturalH = bmp.height; }
    loaded[index] = true; keep(index, bmp);
    if (index === 1) { document.getElementById('loadmsg').style.display = 'none'; }
  } catch(e) {
    // Optional: show error for first frame
    if (index === 1) document.getElementById('loadmsg').textContent = 'Frame not found: ' + PATH(1);
  } finally {
    inflight.delete(index);
  }
}

function warm(start, n){
  for (let k=0;k<n;k++){
    const idx = ((start-1+k) % FRAME_COUNT) + 1; // wrap lookahead
    load(idx);
  }
}

/* ===== Progress → frame index ===== */
function idxFromProgress(p){
  if (LOOP_MODE === "pingpong"){
    const t = p*2; const fwd = t<=1; const u = fwd ? t : 2-t; // 0..1..0
    return Math.round(u*(FRAME_COUNT-1))+1;
  } else {
    const u = p % 1;
    return Math.round(u*(FRAME_COUNT-1))+1;
  }
}

/* ===== ScrollTrigger → target index ===== */
let targetIndex = 1;
ScrollTrigger.create({
  trigger: '.seq',
  start: 'top top',
  end: '+=260%',        // increase if you want longer scrub
  scrub: 0.1,
  pin: '.pin',
  anticipatePin: 1,
  onUpdate: self => {
    targetIndex = idxFromProgress(self.progress);
    warm(targetIndex, 12);
  }
});

/* ===== RAF renderer with easing toward target ===== */
let currentIndex = 1;
function render(){
  // ease toward target to avoid stutter; tune 0.2..0.35
  const next = currentIndex + (targetIndex - currentIndex) * 0.25;
  currentIndex = Math.max(1, Math.min(FRAME_COUNT, next));

  const drawIndex = Math.round(currentIndex);
  const bmp = cache.get(drawIndex);
  if (bmp){
    const scale = Math.max(canvas.width/naturalW, canvas.height/naturalH);
    const dw = naturalW*scale, dh = naturalH*scale;
    const dx = (canvas.width-dw)/2, dy=(canvas.height-dh)/2;
    ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(bmp, dx, dy, dw, dh);
  } else {
    // if we’re behind, request more around the current frame
    warm(drawIndex, 16);
  }
  requestAnimationFrame(render);
}

/* ===== Init ===== */
resize();
load(1).then(()=>{ warm(1, 32); requestAnimationFrame(render); });

/* a11y */
if (matchMedia('(prefers-reduced-motion: reduce)').matches) {
  ScrollTrigger.getAll().forEach(s => s.disable());
}
</script>
</body>
</html>
